<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>test github oauth api</title>
    <style media="screen">
      button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding: 10px 20px;
        border-radius: 3px;
        border: 1px solid #c9c9c9;
        background: #ebebeb;
      }

      button:hover {
        background: #dddddd;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button data-login>GitHub Login</button>

    <script src="https://code.jquery.com/jquery-2.2.1.min.js" charset="utf-8"></script>
    <script type="text/javascript">
      // Step 1: Click "Login" button
      // This opens popup window to GitHub "Authorize application" page
      var githubUrl = 'https://github.com/login/oauth/authorize' +
        '?client_id=b03bc5ca34364a72bd75&scope=user:email,gist';

      var windowOptions = [
        'toolbar=no',
        'location=no',
        'status=no',
        'menubar=no',
        'scrollbars=yes',
        'resizable=yes',
        "width=1080",
        'height=600'
      ].join(',')

      $('button[data-login]').click(function() {
        window.open(githubUrl, 'oAuthWindow', windowOptions);
      });

      // Step 2: Click "Authorize application" in popup

      // Step 3: GitHub calls /test-github-oauth-callback.html
      // This is set on GitHub under "Authorization callback URL"

      // Step 4: The test-github-oauth-callback.html page grabs the code recevied from
      // GitHub in the URL and passes it back to this page via window.opener.postMessage
      window.addEventListener('message', function (event) {
        var code = event.data;

        // Step 6: POST code to Elixir API
        $.ajax({
          type: 'POST',
          url: 'http://localhost:4000/api/github_oauth',
          data: {code: code}
        }).done(function(response) {
          console.log('yeah!', response);

          // Step 8: Elixir API receives code and makes POST to GitHub with
          // application id and secret key for full access token and user info

          // Step 7: Receive client-safe "auth token" (JWT or db-backed token) from API
          var authToken = response.auth_token;
          console.log(authToken);

          // Step 9: Use received auth token to request an authenticated API resource
          // Example: (this is not implemented on backend)
          // $.ajax({
          //   type: 'GET',
          //   headers: {'Authorization': authToken},
          //   url: 'http://localhost:4000/api/my_gists'
          // }).done(function(response) {
          //   console.log(response)
          // }).fail(function() {
          //   console.log('nope');
          // });

        }).fail(function() {
          console.log('nope');
        });
      });
    </script>
  </body>
</html>
